<!DOCTYPE html>
<html>
<head>
    <script src="./qrcodeReader.js"></script>
</head>
<body>

<div class="select">
    <label for="videoSource">Video source: </label><select id="videoSource"></select>
</div>

<video muted autoplay></video>
<img src="">
<canvas width="1280" height="720" style="display:none;"></canvas>
<div id="result"></div>
<script>

    var videoElement = document.querySelector('video');
    var videoSelect = document.querySelector('select#videoSource');

    navigator.getUserMedia = navigator.getUserMedia ||
            navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.mediaDevices.getUserMedia;

    function gotSources(sourceInfos) {
        for (var i = 0; i !== sourceInfos.length; ++i) {
            var sourceInfo = sourceInfos[i];
            var option = document.createElement('option');
            option.value = sourceInfo.id;
            if (sourceInfo.kind === 'video') {
                option.text = sourceInfo.label || 'camera ' + (videoSelect.length + 1);
                videoSelect.appendChild(option);
            }
        }
    }

    MediaStreamTrack.getSources(gotSources);


    function successCallback(stream) {
        window.stream = stream; // make stream available to console
        videoElement.src = window.URL.createObjectURL(stream);
        videoElement.play();
    }

    function errorCallback(error) {
        console.log('navigator.getUserMedia error: ', error);
    }

    function start() {
        if (window.stream) {
            videoElement.src = null;
            window.stream.getAudioTracks().forEach(track => track.stop());
            window.stream.getVideoTracks().forEach(track => track.stop())
        }
        var videoSource = videoSelect.value;
        var constraints = {
            video: {
                optional: [{
                    sourceId: videoSource
                }],
                mandatory: {
                    minWidth: 1280,
                    minHeight: 720
                }
            }
        };
        navigator.getUserMedia(constraints, successCallback, errorCallback);
    }

    videoSelect.onchange = start;

    start();

    // snapshot
    var canvas = document.querySelector('canvas');
    var ctx = canvas.getContext('2d');

    var qr  = new QrCode();
    qr.callback = function(res, err) {
        if(err) {
            var resolution = `(${videoElement.width}, ${videoElement.height})`;
            document.getElementById('result').innerHTML='failed' + resolution;
        } else {
            document.getElementById('result').innerHTML=res + resolution;
        }
        console.log(res, err);
    };

    function snapshot() {
        if (window.stream) {

            ctx.drawImage(videoElement, 0, 0);
            // "image/webp" works in Chrome.
            // Other browsers will fall back to image/png.
            document.querySelector('img').src = canvas.toDataURL('image/webp');

            var data = ctx.getImageData(0, 0, 1280, 720);
            console.log(data);

            qr.decode(data);
        }
    }

    videoElement.addEventListener('click', snapshot, false);

</script>
</body>
</html>
