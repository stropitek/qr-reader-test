<!DOCTYPE html>
<html>
<head>
    <!--<script src="./qrcodeReader.js"></script>-->
    <script src="./jquery-3.1.1.min.js"></script>
</head>
<body>

<div style="position:relative;">
    <div id="restart" style="display: none; position: absolute; z-index: 2000">
        <div id="result"></div>
        <input type="button" value="restart"/>
    </div>
    <div id="shadow"></div>
    <video muted autoplay></video>
</div>
<!--<img src="">-->
<canvas style="display:none;"></canvas>
<script>
    var width = 1280;
    var height = 720;
    var crop = 300;
    createShadow();
    var interval;
    var working = false;
    var videoElement = document.querySelector('video');
    var canvas = document.querySelector('canvas');
    canvas.width = width;
    canvas.height = height;
    $('#restart').css({
        width: width,
        height: height,
        backgroundColor: 'white'
    });

    navigator.getUserMedia = navigator.getUserMedia ||
            navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.mediaDevices.getUserMedia;

    function gotSources(sourceInfos) {
        if (sourceInfos) {
            for (var i = 0; i !== sourceInfos.length; ++i) {
                var sourceInfo = sourceInfos[i];
                var option = document.createElement('option');
                option.value = sourceInfo.id;
                if (sourceInfo.kind === 'video') {
                    option.text = sourceInfo.label || 'camera ' + (videoSelect.length + 1);
                    videoSelect.appendChild(option);
                }
            }
        } else {

        }
    }


    function successCallback(stream) {
        window.stream = stream; // make stream available to console
        videoElement.src = window.URL.createObjectURL(stream);
        videoElement.play();
    }

    function errorCallback(error) {
        console.log('navigator.getUserMedia error: ', error);
    }

    function start() {
        if (window.stream) {
            videoElement.src = null;
            window.stream.getAudioTracks().forEach(track => track.stop());
            window.stream.getVideoTracks().forEach(track => track.stop())
        }
        var constraints = {
            video: {
                mandatory: {
                    minWidth: width,
                    minHeight: height
                }
            }
        };
        navigator.getUserMedia(constraints, successCallback, errorCallback);
    }

    start();

    var worker = new Worker('reader-worker.js');
    worker.onmessage = handleWorkerRead;
    worker.onerror = handleWorkerError;

    // snapshot
    var ctx = canvas.getContext('2d');

    //    var qr  = new QrCode();
    //    qr.callback = function(res, err) {
    //        console.timeEnd('snapshot');
    //        if(err) {
    //            var resolution = `(${videoElement.width}, ${videoElement.height})`;
    //            document.getElementById('result').innerHTML='failed' + resolution;
    //        } else {
    //            document.getElementById('result').innerHTML=res + resolution;
    //        }
    //        console.log(res, err);
    //    };

    function handleWorkerRead(event) {
        console.timeEnd('total');
        console.log(event.data);
        working = false;
        if (event.data.res) {
            stopScanning();
            $('#result').html(event.data.res);
        }
    }

    function handleWorkerError(err) {
        console.error(err);
    }

    function snapshot() {
        if (working) return;
        if (window.stream) {
            console.time('total');
            console.time('snapshot');

            ctx.drawImage(videoElement, 0, 0);
            // "image/webp" works in Chrome.
            // Other browsers will fall back to image/png.
//            document.querySelector('img').src = canvas.toDataURL('image/webp');


            var data = ctx.getImageData((width - crop) / 2, (height - crop) / 2, crop, crop);
            console.timeEnd('snapshot');
            working = true;
            worker.postMessage(data.data.buffer, [data.data.buffer]);
        }
    }

    function startScanning() {
        if(!interval) {
            interval = setInterval(snapshot, 100);
        }
        $('#restart').hide();
    }

    function stopScanning() {
        clearInterval(interval);
        interval = undefined;
        $('#restart').show();
    }

    //    videoElement.addEventListener('click', snapshot, false);

    startScanning();

    function createShadow() {
        var shadow = $('#shadow');
        // create 4 shadow rect
        var div1 = getShadowRect(0, 0, (width - crop) / 2, height);
        var div2 = getShadowRect((width - crop) / 2, 0, crop, (height - crop) / 2);
        var div3 = getShadowRect((width - crop) / 2, (height + crop) / 2, crop, (height - crop) / 2);
        var div4 = getShadowRect((width + crop) / 2, 0, (width - crop) / 2, height);
        shadow.append(div1, div2, div3, div4);
    }

    function getShadowRect(left, top, w, h) {
        var div = $('<div>');
        div.css({
            backgroundColor: '#000000',
            position: 'absolute',
            top: top,
            left: left,
            width: w,
            height: h,
            zIndex: 1000,
            opacity: 0.2
        });

        return div;
    }

    $('#restart').children('input').on('click', function () {
        startScanning();
    });
</script>
</body>
</html>
